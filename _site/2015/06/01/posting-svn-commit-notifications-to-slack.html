<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lumue.github.io by lumue</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <link rel="alternate" type="application/rss+xml" title="gosub" href="http://lumue.github.io/feed.xml">
</head>
<body>
<div class="wrapper">
    <header>
    <h1 class="header">
        <a href="/index.html">gosub</a>
    </h1>

    <p class="header">
        a weblog
    </p>

    <p> <ul class="tag-cloud">
    
    <li class="tag-cloud-item" style="font-size: 86%">
        <a href="#java">
            java
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#spring-boot">
            spring-boot
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#eai">
            eai
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#spring-integration">
            spring-integration
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#spring">
            spring
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 86%">
        <a href="#linux">
            linux
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#network">
            network
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#monitoring">
            monitoring
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#dd-wrt">
            dd-wrt
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#programming">
            programming
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#testing">
            testing
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#html5">
            html5
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#html">
            html
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#python">
            python
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#kodi">
            kodi
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#docker">
            docker
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#getdown">
            getdown
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#devops">
            devops
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#svn">
            svn
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 78%">
        <a href="#slack">
            slack
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#firebird">
            firebird
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#glassfish">
            glassfish
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#jee">
            jee
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 74%">
        <a href="#gaming">
            gaming
        </a>
    </li>
    
</ul></p>

    <ul class="button-list">
        <li class="button-list-item"><a class="buttons github" href="https://github.com/lumue">github/lumue</a></li>
        <li class="button-list-item">
            <a href="https://twitter.com/lutzmueller" class="buttons" data-show-count="false" data-show-screen-name="false">@lutzmueller</a>
            <script>
                !function (d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
                    if (!d.getElementById(id)) {
                        js = d.createElement(s);
                        js.id = id;
                        js.src = p + '://platform.twitter.com/widgets.js';
                        fjs.parentNode.insertBefore(js, fjs);
                    }
                }(document, 'script', 'twitter-wjs');
            </script>
        </li>
    </ul>

</header>
    <section>
        <h1 id="posting-svn-commit-notifications-to-slack">Posting svn commit notifications to slack</h1>

<p>We are trying out <a href="http://www.slack.com">slack</a> as a communication tool at work, and i thought it would be nice to post notifications about commits to our <a href="https://subversion.apache.org">svn</a> repository to the channel i set up for project stuff.  <br />
So the plan is to setup a <a href="http://svnbook.red-bean.com/de/1.7/svn.ref.reposhooks.post-commit.html">post-commit hook</a>  on the svn host which calls into slacks webapi.</p>

<h2 id="posting-to-the-slack-webapi">Posting to the slack webapi</h2>

<p>I have already described howto post to slack channels from the shell in <a href="/2015/06/01/posting-to-slack-from-shell.html">another post</a>.  <br />
To make it easier for to send the commit information to slack, i modified the script from the above mentioned post to accept a svn repo location and a revision number (which is what we get passed into the svn hook handler) instead of the message.<br />
Also the user and channel name are fix.</p>

<p>Now it looks like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c">#these have to be obtained from slack</span>
<span class="nv">api_token</span><span class="o">=</span><span class="s2">"your slack webapi token"</span>
<span class="nv">url</span><span class="o">=</span><span class="s2">"https://your webhook url"</span>

<span class="nv">username</span><span class="o">=</span><span class="s2">"svnbot"</span>
<span class="nv">channel</span><span class="o">=</span><span class="s2">"#korona-resource"</span>

<span class="c">#commandline parameter</span>
<span class="nv">repo</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">revision</span><span class="o">=</span><span class="nv">$2</span>

<span class="c">#build message</span>
<span class="nv">message</span><span class="o">=</span><span class="sb">`</span>svn log --revision <span class="nv">$revision</span> <span class="nv">$repo</span><span class="sb">`</span>
<span class="nv">message</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$message</span> | iconv -f iso8859-1 -t ascii//translit<span class="sb">`</span>
<span class="nv">message</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$message</span> | sed <span class="s2">"s/'/</span><span class="se">\\\\\'</span><span class="s2">/g"</span><span class="sb">`</span>
<span class="nv">message</span><span class="o">=</span><span class="k">${</span><span class="nv">message</span><span class="p">//--/</span><span class="k">}</span>
<span class="nv">message</span><span class="o">=</span><span class="k">${</span><span class="nv">message</span><span class="p">//|/\\n</span><span class="k">}</span>

<span class="c">#build json</span>
<span class="nv">jsonstring</span><span class="o">=</span><span class="s2">"{</span><span class="se">\"</span><span class="s2">token</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$api_token</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">channel</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$channel</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">username</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$username</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">text</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$message</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">icon_emoji</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">:ghost:</span><span class="se">\"</span><span class="s2">}"</span>
<span class="nb">echo</span> <span class="nv">$jsonstring</span> &gt; /tmp/slack_git_msg

<span class="c">#call curl</span>
curl -i -X POST -H <span class="s1">'Accept: application/json'</span> -H <span class="s2">"Content-Type: application/json; charset=ascii"</span>  --data @/tmp/slack_git_msg <span class="nv">$url</span></code></pre></figure>

<p>As you can see, there is some converting and replacing magic involved, to end up with a message which curl can hand over as valid json.</p>

<h2 id="the-svn-side">The SVN side</h2>

<p>Place the above script in a location where it is callable from svn (e.g. /usr/bin) and give it the appropriate execution rights.</p>

<p>Next we have to tell svn to call the script and pass it the correct parameters after each commit to our repository(-branch).  <br />
To do this, edit the post-commit script of your repository. Its usually located in <code>&lt;path-to-repo&gt;/hooks/post-commit</code>.</p>

<p>Add the following lines:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">"</span><span class="k">$(</span>svnlook changed <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span> -r <span class="k">${</span><span class="nv">REV</span><span class="k">}</span> | grep &lt;branchname&gt;<span class="k">)</span><span class="s2">"</span> <span class="o">]</span>
<span class="k">then</span>
  /usr/bin/slack_send_svnlog.sh <span class="k">${</span><span class="nv">REPOS</span><span class="k">}</span> <span class="k">${</span><span class="nv">REV</span><span class="k">}</span>
<span class="k">fi</span></code></pre></figure>

<p>And we are done here. A commit should now produce a post displaying the commit message in the selected slack channel:</p>

<p><img src="/assets/slack-svn-post-screen.png" alt="your commit message in slack" /></p>

        <div class="post-tags">
  Tags: 
  
  
  <a href="/tags/#svn">svn</a>,
  
  <a href="/tags/#slack">slack</a>
  
</div>
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lumue'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </section>
    <footer>
        <p>
            <small>Hosted on <a href="http://pages.github.com">GitHub Pages</a>
            </small>
        </p>
        <p>
            <small><a href="http://lumue.github.io/feed.xml">RSS</a>
            </small>
        </p>
    </footer>
</div>
<!--[if !IE]>
<script>fixScale(document);</script><![endif]-->

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69535101-1', 'auto');
    ga('send', 'pageview');

</script>

</body>
</html>
