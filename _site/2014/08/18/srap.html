<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lumue.github.io by lumue</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <link rel="alternate" type="application/rss+xml" title="gosub" href="http://lumue.github.io/feed.xml">
</head>
<body>
<div class="wrapper">
    <header>
    <h1 class="header">
        <a href="/index.html">gosub</a>
    </h1>

    <p class="header">
        a weblog
    </p>

    <p> <ul class="tag-cloud">
    
    <li class="tag-cloud-item" style="font-size: 81%">
        <a href="#java">
            java
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#spring-integration">
            spring-integration
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#spring">
            spring
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 89%">
        <a href="#coding">
            coding
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 85%">
        <a href="#linux">
            linux
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#network">
            network
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#monitoring">
            monitoring
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#dd-wrt">
            dd-wrt
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 81%">
        <a href="#sysadmin">
            sysadmin
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#html">
            html
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#python">
            python
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#kodi">
            kodi
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#docker">
            docker
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#devops">
            devops
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#spring-boot">
            spring-boot
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 81%">
        <a href="#project automation">
            project automation
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#svn">
            svn
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#slack">
            slack
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 77%">
        <a href="#bash">
            bash
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#firebird">
            firebird
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#glassfish">
            glassfish
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#jee">
            jee
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#gaming">
            gaming
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#debian">
            debian
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#systemd">
            systemd
        </a>
    </li>
    
    <li class="tag-cloud-item" style="font-size: 73%">
        <a href="#g13">
            g13
        </a>
    </li>
    
</ul></p>

    <ul class="button-list">
        <li class="button-list-item"><a class="buttons github" href="https://github.com/lumue">github/lumue</a></li>
        <li class="button-list-item">
            <a href="https://twitter.com/lutzmueller" class="buttons" data-show-count="false" data-show-screen-name="false">@lutzmueller</a>
            <script>
                !function (d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
                    if (!d.getElementById(id)) {
                        js = d.createElement(s);
                        js.id = id;
                        js.src = p + '://platform.twitter.com/widgets.js';
                        fjs.parentNode.insertBefore(js, fjs);
                    }
                }(document, 'script', 'twitter-wjs');
            </script>
        </li>
        <li>
            <a href="http://feeds.feedburner.com/gosub" rel="alternate" type="application/rss+xml"><img src="//feedburner.google.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>&nbsp;<a href="http://feeds.feedburner.com/gosub" rel="alternate" type="application/rss+xml">RSS</a>
        </li>
    </ul>

</header>
    <section>
        <h1 id="load-balancing-insert-and-update-requests-to-a-http-api-using-spring-integration">Load balancing insert and update requests to a http api using spring-integration</h1>

<h2 id="overview">Overview</h2>

<p>We will use a message queue to achieve asynchronous processing of insert and update requests to a webapi.</p>

<h3 id="why-is-it-important">Why is it important</h3>

<p>Imagine what happens in your application if suddenly a lot of requests start coming in, which demand synchronous transaction execution against a database. The webserver will start to spawn more threads. Each of these threads has to acquire a database connection. This will not only drain your http-threadpool, but also your applications connection pool. after a while, most threads will be waiting for a database connection. which in turn leads to the webserver spawning more and more threads. eventually your application becomes unresponsive. </p>

<p>So http-threads are a resource you do not want to hog. this is even more important if your application is accessible on the public internet.  </p>

<p>it is also a good thing to decouple your backend workload from the http-request frequency. remember that every thread that executes a transaction against a database likely also occupies a db connection. </p>

<h3 id="how-does-it-work-the-short-version">How does it work (the short version)</h3>

<p>When invoking a service-method directly from a http-request-processing thread, it will be occupied until the transaction completes. To avoid this, the request is handed off to a message queue and delivered to a service-activator endpoint. </p>

<p>this way, updates can be queued while your backend-threads and database eat them up at a steady load.</p>

<p>if guaranteed delivery is needed, the message queue can be made persistent with a message store. a http ok response is sent only if the message has been added to the queue. </p>

<h3 id="when-not-to-use-this">When (not) to use this</h3>

<p>This pattern is useful if you have to handle a large amount of non trivial create or update requests to your backend in a short amount of time. Consider it especially if you have a public facing api or a spiky usage pattern.   </p>

<p>Its not applicable if the clients requires a response containing processing results. In this case consider to redesign your endpoint api to allow for “fire and forget” style requests: </p>

<p>Does your client really need to know if the backend transaction completed successfully, or is it enough to acknowledge the delivery? </p>

<p>Is it possible to pull the backend for results later?     </p>

<p>Obviously, this adds another level of complexity and also some overhead to your application. So only use it, if you need it. Fortunately, if you design your service api with this pattern in mind, its easy to add the implementation later.</p>

<h2 id="an-example">An example</h2>

<p>You have built an application which receives and processes orders from thousands of clients around the country. you even stress tested it with the expected workload of 500.000 orders a day and everything works fine.</p>

<h3 id="there-is-always-a-little-detail-missing-from-the-spec">There is always a little detail missing from the spec!</h3>

<p>but after it is deployed to production, complaints start coming in. apparently each order has to be sent several times until it is accepted and also the userinterface seems to become slow and unresponsive every night. So you check the logs and notice a lot of exceptions which look like this:</p>

<p><code>
</code></p>

<p>turns out there is a little detail about that specified load which you haven’t been told: all the clients start sending their orders at the same time every night!</p>

<h3 id="the-application">The Application</h3>

<h4 id="the-domainmodel">The Domainmodel</h4>

<p>Is a really simple one (after all it is an example application!). </p>

<p><img src="/resources/2014-08-18-srap-domain-classDiagram.PNG" alt="domain model" /> </p>

<p>But there is a small gotcha with serious implications on the processing of orders. As you can see, the product quantity on stock is a direct property of <code>Product</code>. Since the processing of an order involves the update of stock, the corresponding row in the product table has to be locked, which in turn requires the transaction isolation level to be serializable.</p>

<h4 id="object-persistence">Object Persistence</h4>

<p>The domain objects are persisted using JPA and hibernate. Mysql is used as a database. Nothing special here.</p>


        <div class="post-tags">
  Tags: 
  
    
  
  
  <a href="/tags/#java">java</a>,
  
  <a href="/tags/#spring-integration">spring-integration</a>,
  
  <a href="/tags/#spring">spring</a>,
  
  <a href="/tags/#coding">coding</a>
  
</div>
        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lumue'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </section>
    <footer>
        <p>
            <small>Hosted on <a href="http://pages.github.com">GitHub Pages</a>
            </small>
        </p>
        <p>
            <small><a href="http://lumue.github.io/feed.xml">RSS</a>
            </small>
        </p>
    </footer>
</div>
<!--[if !IE]>
<script>fixScale(document);</script><![endif]-->

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69535101-1', 'auto');
    ga('send', 'pageview');

</script>

</body>
</html>
